#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail
if [[ "${TRACE-0}" == "1" ]]; then
	set -o xtrace
fi

show_help() {
    cat << EOF
Usage: cticket [OPTIONS]

Create a JIRA ticket for a Jujutsu bookmark using Claude AI.

This interactive script guides you through creating a JIRA ticket by:
  1. Selecting a bookmark (Jujutsu branch)
  2. Choosing a sprint
  3. Assigning story points
  4. Selecting an epic
  5. Choosing an assignee
  6. Having Claude generate the ticket content

OPTIONS:
    -r, --revset REVSET  Use a custom revset instead of the default
    --stacked            Create a stacked diff ticket (prompts for base bookmark)
    --bug                Create a bug ticket (prompts for additional context)
    --help               Display this help message and exit

EXAMPLES:
    # Create a regular ticket
    cticket

    # Create a stacked diff ticket
    cticket --stacked

    # Create a bug ticket
    cticket --bug

    # Use a custom revset
    cticket -r 'ancestors(@, 3)'

ENVIRONMENT:
    TRACE        Set to '1' to enable bash tracing

DEPENDENCIES:
    - jira       JIRA CLI tool
    - gum        Terminal UI tool
    - fzf        Fuzzy finder
    - claude     Claude AI CLI
    - jj         Jujutsu version control

EOF
}

main() {
    # Have Claude create a JIRA ticket
    local bookmark
    local base="trunk()"
    local stacked=false
    local bug=false
    local ticket_type="story"
    local bug_context=""
    local sprint
    local points
    local epic
    local assignee
    local revset

    # Parse command-line arguments first
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --help)
                show_help
                return 0
                ;;
            -r|--revset)
                revset="$2"
                shift 2
                ;;
            --stacked)
                stacked=true
                shift
                ;;
            --bug)
                bug=true
                ticket_type="bug"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    # Prompt for bug context when --bug is given
    if [ "${bug}" = true ]; then
        local context_choice
        context_choice=$(gum choose "Type it in" "Attach a file" "No context" --header="Provide additional context for the bug:")
        case "$context_choice" in
            "Type it in")
                bug_context=$(gum write --placeholder "Describe the bug context..." --header "Bug Context")
                ;;
            "Attach a file")
                bug_context=$(gum file --header "Select a file with bug context")
                ;;
            "No context")
                bug_context=""
                ;;
        esac
    fi

    sprint=$( { jira sprints \
        | grep DSSO \
        | cut -d '|' -f1,2 \
        | column -s '|' -t; \
        echo "Backlog"; } \
        | gum choose \
        | sed 's/  *active\|future.*//' \
    )

    points=$(gum choose "None" 0.5 1 2 3 5 8 13 --header="Select points for the ticket:")
    epic=$(jira issues --human --epics-only \
        | fzf \
        --ansi \
        --header-lines=1 \
        --bind='enter:become(echo {1})' \
        --preview-window=up:50% \
        --preview='jira view --rich {1}' \
        --prompt='Select an epic for the ticket > ' \
    )

    assignee=$(gum choose "hdemers" "<leave unassigned>" --header="Select assignee for the ticket:")

    if [ -z "${revset:-}" ]; then
        . "$HOME"/.shellrc.d/05-jj-functions.sh

        bookmark=$(_select_bookmark "" "Select a bookmark to create a JIRA ticket for:")

        if [ -z "$bookmark" ]; then
            gum log --level error "You must provide a bookmark."
            return 1
        fi

        if [ "${stacked}" = true ]; then
            base=$(_select_bookmark "" "Select a base bookmark for the stacked diffs:")
            if [ -z "$base" ]; then
                gum log --level error "You must provide a base."
                return 1
            fi
        fi
        revset=${base}..${bookmark}

        # Check for other bookmarks in the revset when not using --stacked
        if [ "${stacked}" = false ]; then
            local other_bookmarks
            other_bookmarks=$(jj log -r "${revset}" --no-graph -T 'if(bookmarks, bookmarks ++ "\n")' \
                | grep -v "^${bookmark}\*\?$" \
                | grep -v "^$" \
                || true)

            if [ -n "$other_bookmarks" ]; then
                gum log --level warn "Found other bookmarks in the revset: ${other_bookmarks//$'\n'/, }"
                gum confirm "Did you forget to use --stacked? Continue anyway?" || {
                    gum log --level info "Ticket creation cancelled. Rerun with --stacked if needed."
                    return 0
                }
            fi
        fi
    fi

    export AGENT_REVSET="${revset}"
    export AGENT_TICKET_EPIC="${epic}"
    export AGENT_TICKET_SPRINT="${sprint}"
    export AGENT_TICKET_POINTS="${points}"
    export AGENT_TICKET_ASSIGNEE="${assignee}"
    export AGENT_TICKET_PROJECT="DSSO"
    export AGENT_TICKET_TYPE="${ticket_type}"
    if [ -n "${bug_context}" ]; then
        export AGENT_BUG_CONTEXT="${bug_context}"
    fi
    export TMPDIR=/tmp/claude

    gum confirm "$(printf 'Do you want to create a JIRA ticket for\nType: %s\nRevset: %s\nEpic: %s\nSprint: %s\nPoints: %s\nAssignee: %s' "$ticket_type" "$revset" "$epic" "$sprint" "$points" "$assignee")" || {
        gum log --level info "Ticket creation cancelled."
        return 0
    }
    claude "/jj-ticket"
    unset AGENT_REVSET
    unset AGENT_TICKET_EPIC
    unset AGENT_TICKET_SPRINT
    unset AGENT_TICKET_POINTS
    unset AGENT_TICKET_ASSIGNEE
    unset AGENT_TICKET_PROJECT
    unset AGENT_TICKET_TYPE
    unset AGENT_BUG_CONTEXT
    unset TMPDIR


}

main "$@"

# vim: set ft=sh
